#!/bin/bash

# üöÄ Script de Configura√ß√£o Autom√°tica - Neon PostgreSQL + Netlify Deploy
# Sistema de Gest√£o de Clientes SENAI v3.0

echo "=========================================="
echo "üè¢ SETUP AUTOM√ÅTICO - GEST√ÉO DE CLIENTES"
echo "üöÄ Deploy: Netlify + Neon PostgreSQL"
echo "=========================================="
echo

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Fun√ß√£o de log
log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  INFO:${NC} $1"
}

log_success() {
    echo -e "${GREEN}‚úÖ SUCCESS:${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING:${NC} $1"
}

log_error() {
    echo -e "${RED}‚ùå ERROR:${NC} $1"
}

# Verificar depend√™ncias
log_info "Verificando depend√™ncias..."

if ! command -v git &> /dev/null; then
    log_error "Git n√£o encontrado. Instale o Git primeiro."
    exit 1
fi

if ! command -v node &> /dev/null; then
    log_warning "Node.js n√£o encontrado. Algumas funcionalidades podem n√£o funcionar."
fi

log_success "Depend√™ncias verificadas"

# Configurar Git (se necess√°rio)
log_info "Configurando reposit√≥rio Git..."

git config --global --get user.name > /dev/null || {
    log_warning "Configura√ß√£o Git necess√°ria"
    echo -n "Digite seu nome para Git: "
    read GIT_NAME
    git config --global user.name "$GIT_NAME"
}

git config --global --get user.email > /dev/null || {
    echo -n "Digite seu email para Git: "
    read GIT_EMAIL
    git config --global user.email "$GIT_EMAIL"
}

# Verificar se j√° √© um reposit√≥rio Git
if [ ! -d ".git" ]; then
    log_info "Inicializando reposit√≥rio Git..."
    git init
    git remote add origin https://github.com/cristiano-superacao/gestao_clientes.git
fi

# Instalar depend√™ncias Node.js (se dispon√≠vel)
if command -v npm &> /dev/null && [ -f "package.json" ]; then
    log_info "Instalando depend√™ncias Node.js..."
    npm install
    log_success "Depend√™ncias instaladas"
fi

# Configura√ß√£o do Neon PostgreSQL
log_info "Configura√ß√£o do Neon PostgreSQL"
echo
echo "Para configurar o Neon PostgreSQL:"
echo "1. Acesse: https://console.neon.tech/"
echo "2. Crie uma conta gratuita"
echo "3. Crie um novo projeto: 'gestao-clientes'"
echo "4. Copie a Connection String"
echo
echo -n "Cole sua Database URL do Neon (pressione Enter para usar demo): "
read NEON_URL

if [ -z "$NEON_URL" ]; then
    NEON_URL="postgresql://demo_user:demo_pass@ep-demo-123456.us-east-1.aws.neon.tech/gestao_clientes?sslmode=require"
    log_warning "Usando configura√ß√£o demo do Neon"
else
    log_success "URL do Neon configurada"
fi

# Atualizar netlify.toml com a URL do Neon
log_info "Atualizando configura√ß√£o do Netlify..."
sed -i "s|DATABASE_URL = \".*\"|DATABASE_URL = \"$NEON_URL\"|g" netlify.toml
log_success "Configura√ß√£o do Netlify atualizada"

# Configura√ß√£o do Netlify
log_info "Configura√ß√£o do Deploy Netlify"
echo
echo "Para fazer o deploy autom√°tico:"
echo "1. Acesse: https://app.netlify.com/"
echo "2. Conecte sua conta GitHub"
echo "3. Importe este reposit√≥rio: cristiano-superacao/gestao_clientes"
echo "4. Configure as vari√°veis de ambiente:"
echo "   - DATABASE_URL: $NEON_URL"
echo "5. Deploy ser√° autom√°tico a cada git push"
echo

# Commit das configura√ß√µes
log_info "Salvando configura√ß√µes..."
git add .
git commit -m "üöÄ AUTO-SETUP: Configura√ß√£o Neon PostgreSQL + Deploy Netlify"

# Push para GitHub
log_info "Enviando para GitHub..."
git push -u origin master || {
    log_warning "Push falhou. Verifique as credenciais do GitHub"
    echo "Execute manualmente: git push -u origin master"
}

log_success "Configura√ß√£o conclu√≠da!"

echo
echo "=========================================="
echo "üéâ SETUP FINALIZADO COM SUCESSO!"
echo "=========================================="
echo
echo "üì± URLs do Sistema:"
echo "   ‚Ä¢ Local: http://localhost:3000 (execute: npm run dev)"
echo "   ‚Ä¢ Produ√ß√£o: https://gestaodecliente.netlify.app/"
echo
echo "üîß Pr√≥ximos Passos:"
echo "   1. Configure o Neon PostgreSQL em: https://console.neon.tech/"
echo "   2. Configure o Netlify em: https://app.netlify.com/"
echo "   3. Atualize a vari√°vel DATABASE_URL no Netlify"
echo "   4. Execute: npm run dev (para teste local)"
echo
echo "üìö Documenta√ß√£o:"
echo "   ‚Ä¢ README.md - Guia completo"
echo "   ‚Ä¢ TESTE-LOCAL.md - Testes locais"
echo
echo "‚úÖ Sistema pronto para uso!"